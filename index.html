<?php
session_start();

$clientId = 'u-s4t2ud-1a7185f0b087881bd3b9143c93ec1be271d06f4db7f60ceef2a57a6b8ba8c94b';
$clientSecret = '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';
$redirectUri = 'https://42explorer.github.io/';

$retour = [
	'code' => 0,
	'message' => 'rien'
];

$key = "wegfMl3Jqw548few64fw45f";

function encrypt($data, $key) {
	$iv = openssl_random_pseudo_bytes(openssl_cipher_iv_length('aes-256-cbc'));
	$encrypted = openssl_encrypt($data, 'aes-256-cbc', $key, 0, $iv);
	return base64_encode($encrypted . '::' . $iv);
}

function decrypt($data, $key) {
	list($encryptedData, $iv) = explode('::', base64_decode($data), 2);
	return openssl_decrypt($encryptedData, 'aes-256-cbc', $key, 0, $iv);
}

if (isset($_GET['action']) && $_GET['action'] === 'login') {
    $state = bin2hex(random_bytes(16));
    $_SESSION['state'] = $state;
    $params = [
        'client_id' => $clientId,
        'redirect_uri' => $redirectUri,
        'response_type' => 'code',
        'scope' => 'public',
        'state' => $state
    ];
    $url = 'https://api.intra.42.fr/oauth/authorize?' . http_build_query($params);
    header('Location: ' . $url);
}

if (isset($_GET['code'])) {
	if (!isset($_SESSION['login']) || (isset($_SESSION['login']) && empty($_SESSION['login']) && (!isset($_SESSION['code']) || $_SESSION['code'] !== $_GET['code']))) {
		$_SESSION['code'] = $_GET['code'];
    	$tokenUrl = 'https://api.intra.42.fr/oauth/token';
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, $tokenUrl);
		curl_setopt($ch, CURLOPT_POST, true);
		curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
			'grant_type' => 'authorization_code',
			'client_id' => $clientId,
			'client_secret' => $clientSecret,
			'code' => $_GET['code'],
			'redirect_uri' => $redirectUri
		]));
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		$response = curl_exec($ch);
		$data = json_decode($response, true);
		$accessToken = $data['access_token'];

		$meUrl = 'https://api.intra.42.fr/v2/me';
		curl_setopt($ch, CURLOPT_URL, $meUrl);
		curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization: Bearer ' . $accessToken]);
		curl_setopt($ch, CURLOPT_POST, false);
		$userResponse = curl_exec($ch);
		$userData = json_decode($userResponse, true);
		curl_close($ch);
		if (!isset($userData['login'])) {
			$retour['code'] = 1;
			$retour['message'] = 'Erreur lors de la récupération du login';
			echo json_encode($retour);
			exit();
		}
		$_SESSION['login'] = encrypt($userData['login'], $key);
	}
	$decrypt = decrypt($_SESSION['login'], $key);
	$retour['message'] = $_SESSION['login'] . ' - ' . $decrypt;
	echo json_encode($retour);
	exit();
}

if (isset($_GET['login']) && !empty($_GET['login']) && isset($_GET['message']) && !empty($_GET['message'])) {
    $projectId = 'conf-request';
    $collection = 'questions';
    $apiKey = 'AIzaSyDAhazuV51FBXevU95zvchigy4fe7ofzyM';
    $url = "https://firestore.googleapis.com/v1/projects/$projectId/databases/(default)/documents/$collection?key=$apiKey";
	$login = decrypt($_SESSION['login'], $key);
    $data = [
        'fields' => [
            'login' => ['stringValue' => $login],
            'question' => ['stringValue' => $_GET['message']]
        ]
    ];
    $dataJson = json_encode($data);

    $curl = curl_init();
    curl_setopt($curl, CURLOPT_URL, $url);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($curl, CURLOPT_POSTFIELDS, $dataJson);
    curl_setopt($curl, CURLOPT_POST, true);
    curl_setopt($curl, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Content-Length: ' . strlen($dataJson)
    ]);

    $response = curl_exec($curl);
    if ($response === false) {
		$retour['code'] = 1;
		$retour['message'] = 'Erreur lors de l\'envoi de la question';
	} else {
		$retour['code'] = 0;
		$retour['message'] = 'Question envoyée';
    }
    curl_close($curl);
}
?>



curl 'https://theomouty.fr/42explorer/?code=ff95ae49b4a4c6a57dc2473276bd4af771c83d1130e9f659af86c5257b2b1c66' \
  -H 'authority: theomouty.fr' \
  -H 'accept: */*' \
  -H 'accept-language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7' \
  -H 'content-type: application/json' \
  -H 'origin: https://42explorer.github.io' \
  -H 'referer: https://42explorer.github.io/' \
  -H 'sec-ch-ua: "Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "Linux"' \
  -H 'sec-fetch-dest: empty' \
  -H 'sec-fetch-mode: cors' \
  -H 'sec-fetch-site: cross-site' \
  -H 'user-agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' \
  --compressed
